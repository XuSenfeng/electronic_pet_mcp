# 开发

## MCP

### 现有的MCP服务

```
git clone git@github.com:shenjingnan/xiaozhi-client.git
```

> 下载一个客户端

```
## 安装
npm i -g xiaozhi-client

## 创建项目
xiaozhi create my-app --template hello-world

## 进入项目
cd my-app

## 安装依赖（主要是示例代码中mcp服务所使用的依赖）
pnpm install

# 修改 xiaozhi.config.json 中的 mcpEndpoint 为你的接入点地址（需要自行前往xiaozhi.me获取）
# 小智AI配置MCP接入点使用说明：https://ccnphfhqs21z.feishu.cn/wiki/HiPEwZ37XiitnwktX13cEM5KnSb

## 运行
xiaozhi start
```

### 高德地图MCP

```
http://mcp.so/server/amap-maps/amap?tab=content
```

可以把配置添加到填写API的配置文件

```json
"amap-maps": {
    "command": "npx",
    "args": [
        "-y",
        "@amap/amap-maps-mcp-server"
    ],
    "env": {
        "AMAP_MAPS_API_KEY": "你的API"
    }
}
```

> 之后到高德的官网开通服务[我的应用 | 高德控制台](https://console.amap.com/dev/key/app)获取API, 这里使用Wed服务

[excelMCP](https://github.com/haris-musa/excel-mcp-server)

### 自定义MCP示例

#### 一 本地知识库示例

##### 部署ragflow

下载ragflow  `git clone https://github.com/infiniflow/ragflow.git`

需要安装docker

![image-20250626211056992](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202506262110274.png)

换一下可以使用的镜像源

```
"registry-mirrors": [
    "https://docker.xuanyuan.me",
    "https://mirror.ccs.tencentyun.com"
]
```

我这里使用的是上面两个

```bash
docker compose -f docker-compose.yml up -d
```

![image-20250626220806018](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202506262208176.png)

![image-20250626220825169](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202506262208379.png)

![image-20250626222920966](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202506262229177.png)

![image-20250626223028476](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202506262230592.png)

```
docker compose down
docker compose up -d
```

> 以上的测试失败, 下边使用API的方式

##### MCP接口

在使用ragflow的时候, 他默认是有一个MCP接口的, 但是还在试用阶段, 我测试了一下没有成功, 这里使用自己实现的方式达成MCP调用

MCP的注册工具使用另一个UP**[闪电蘑菇](https://space.bilibili.com/24615859?spm_id_from=333.788.upinfo.detail.click)**开发的工具[小智MCP自由了！我开源了个命令行神器实现多MCP聚合](https://www.bilibili.com/video/BV1hxMbzqEzU/?spm_id_from=333.1387.favlist.content.click), 开源地址在[这里](https://github.com/shenjingnan/xiaozhi-client)

下面摘抄一下他的手册

```bash
## 安装
npm i -g xiaozhi-client

## 创建项目
xiaozhi create my-app --template hello-world

## 进入项目
cd my-app

## 安装依赖（主要是示例代码中mcp服务所使用的依赖）
pnpm install

# 修改 xiaozhi.config.json 中的 mcpEndpoint 为你的接入点地址（需要自行前往xiaozhi.me获取）
# 小智AI配置MCP接入点使用说明：https://ccnphfhqs21z.feishu.cn/wiki/HiPEwZ37XiitnwktX13cEM5KnSb

## 运行
xiaozhi start
```

> 这里使用的npm是Node.js的一部分, 放一个网上找的文档[node（npm） 安装及其环境配置完整教程_npm安装及环境配置-CSDN博客](https://blog.csdn.net/qq_45824320/article/details/136601535), 出现问题可以问一下AI

配置好以后打开文件xiaozhi.config.json, 依次填入需要使用的mcp, 这里测试只可以运行本地的mcp, 不可以使用sse格式的

## 整体框架

小智代码部分教程

### 启动流程

esp idf 的代码起始的位置是在app_main函数里面, 小智在这里实际是启动了app的Start函数(app使用全局变量所以在cpp里面会自动的调用构造函数)

Start函数里面首先获取一个板子的句柄, 这个句柄头一次调用的时候会进行创建板子的类, 从而在构造函数里面初始化板子的各种外设, 比如屏幕, 麦克风, 摄像机等

初始化各种外设以后进行网络的连接, 如果本地没有网络的配置, 开启一个HTTP服务器, 创建一个网络连接的界面, 有的话尝试进行网络连接, 如果失败一定次数, 进行上面的服务器部分

连接成功以后需要和小智的服务器进行一系列的数据交换, 比如发送本地的iot/mcp工具的描述符, 各个外设的工作状态等, 同时获取服务器提供的时间和版本信息, 如果有新版本的固件, 根据板子的设置选择是否更新

这部分之后就是各种回调函数的设置, 比如网络连接出现错误的时候怎么做, 唤醒词唤醒的时候怎么处理等等, 同时比较重要的是服务器发过来文字控制信息的时候如何解析

完成这部分以后播放一个提示音

### 小智状态机

小智的主程序就是一个大型的状态机, 当不同的事件到来的时候进行不同状态的切换

目前所有的状态大致分为以下的几个, 通常经常使用的部分是空闲, 聆听, 播放的来回切换

```c
enum DeviceState {
    kDeviceStateUnknown,  // 未知状态
    kDeviceStateStarting, // 启动初始化
    kDeviceStateWifiConfiguring, // 连接网络
    kDeviceStateIdle, // 空闲状态
    kDeviceStateConnecting, // 连接网络
    kDeviceStateListening, // 聆听事件
    kDeviceStateSpeaking, // 播放声音
    kDeviceStateUpgrading, // 更新
    kDeviceStateActivating, // 激活
    kDeviceStateFatalError // 错误状态
};
```



#### 状态机的使用



### 小智图形界面

1. 界面的更改
2. 界面的接口的增加

> 实际可以理解为一个lvgl的开发



### 各个模块

板子, 网络, 背光





